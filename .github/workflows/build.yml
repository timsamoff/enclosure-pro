name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'maintenance/v1.0.0'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to build and release'
        required: true
        default: 'latest'
        type: string
      clean_previous:
        description: 'Delete previous release with same tag?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            artifact_pattern: 'release/*.exe'
          - os: macos-latest  
            platform: macos
            artifact_pattern: 'release/*.dmg'
          - os: ubuntu-latest
            platform: linux
            artifact_pattern: 'release/*.AppImage'
    
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
      CLEAN_PREVIOUS: ${{ github.event_name == 'workflow_dispatch' && inputs.clean_previous || 'true' }}
    
    steps:
      - name: Debug trigger info
        run: |
          echo "üè∑Ô∏è Building for tag: ${{ env.RELEASE_TAG }}"
          echo "üîß Trigger: ${{ github.event_name }}"
          echo "üóëÔ∏è Clean previous: ${{ env.CLEAN_PREVIOUS }}"
          echo "üíª Platform: ${{ matrix.platform }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && env.RELEASE_TAG || '' }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verify and sync version
        shell: bash
        run: |
          echo "üìã Verifying version consistency..."
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Package.json version: $PKG_VERSION"
          echo "Expected tag: ${{ env.RELEASE_TAG }}"
          
          # Clear electron-builder caches
          echo "üßπ Clearing electron-builder caches..."
          rm -rf ~/.cache/electron-builder 2>/dev/null || true
          rm -rf ~/.cache/electron 2>/dev/null || true
          
          echo "‚úÖ Version verified: $PKG_VERSION"
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Verify installation
        run: |
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"
          npx electron-builder --version
          echo "Package version: $(node -p "require('./package.json').version")"
      
      - name: Clean build directories
        shell: bash
        run: |
          rm -rf release
          rm -rf build
          mkdir -p build
      
      - name: Copy icon files for CI build
        shell: bash
        run: |
          echo "üìã Copying icon files..."
          
          # Windows icons
          if [ -f "images/EnclosureProIcon.ico" ]; then
            cp "images/EnclosureProIcon.ico" "build/icon.ico"
            echo "‚úì Windows icon: build/icon.ico"
          fi
          
          if [ -f "images/EnclosureProFileIcon.ico" ]; then
            cp "images/EnclosureProFileIcon.ico" "build/EnclosureProFileIcon.ico"
            echo "‚úì Windows file icon"
          fi
          
          # macOS icons
          if [ -f "images/EnclosureProIcon.icns" ]; then
            cp "images/EnclosureProIcon.icns" "build/EnclosureProIcon.icns"
            echo "‚úì macOS icon"
          fi
          
          if [ -f "images/EnclosureProFileIcon.icns" ]; then
            cp "images/EnclosureProFileIcon.icns" "build/EnclosureProFileIcon.icns"
            echo "‚úì macOS file icon"
          fi
          
          # PNG icons (Linux and general)
          if [ -f "images/EnclosureProIcon.png" ]; then
            cp "images/EnclosureProIcon.png" "build/icon.png"
            echo "‚úì PNG icon: build/icon.png"
          fi
          
          if [ -f "images/EnclosureProFileIcon.png" ]; then
            cp "images/EnclosureProFileIcon.png" "build/EnclosureProFileIcon.png"
            echo "‚úì PNG file icon"
          fi
          
          echo "üìä Build directory contents:"
          ls -la build/
      
      - name: Build Vite app
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Build Electron app
        run: npm run electron:build:only
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_ENV: production
      
      - name: List build artifacts
        shell: bash
        run: |
          echo "üì¶ Artifacts created:"
          find release/ -type f -name "*" 2>/dev/null | while read file; do
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
            echo "  - $(basename "$file") (${size} bytes)"
          done || echo "No artifacts found"
      
      - name: Upload platform artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build-${{ github.run_number }}
          path: ${{ matrix.artifact_pattern }}
          if-no-files-found: error
          retention-days: 7
      
      - name: Upload update files
        uses: actions/upload-artifact@v4
        with:
          name: update-files-${{ matrix.platform }}-${{ github.run_number }}
          path: |
            release/latest*.yml
            release/latest*.json
            release/*.blockmap
          if-no-files-found: ignore
          retention-days: 7

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
      CLEAN_PREVIOUS: ${{ github.event_name == 'workflow_dispatch' && inputs.clean_previous || 'true' }}
    
    steps:
      - name: Debug release info
        run: |
          echo "üéØ Creating release: ${{ env.RELEASE_TAG }}"
          echo "üßπ Clean previous: ${{ env.CLEAN_PREVIOUS }}"
          echo "üîó Run: #${{ github.run_number }}"
      
      - name: Checkout tag for release notes
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      
      - name: Download platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/platforms
          pattern: '*-build-${{ github.run_number }}'
          merge-multiple: false
      
      - name: Download update files
        uses: actions/download-artifact@v4
        with:
          path: artifacts/updates
          pattern: 'update-files-*-${{ github.run_number }}'
          merge-multiple: false
      
      - name: List all downloaded files
        run: |
          echo "üìÇ Downloaded artifacts:"
          find artifacts/ -type f -name "*" 2>/dev/null | sort
          echo ""
          echo "üìä Total files: $(find artifacts/ -type f 2>/dev/null | wc -l)"
      
      - name: Delete existing release (if enabled)
        if: env.CLEAN_PREVIOUS == 'true'
        run: |
          echo "üóëÔ∏è Deleting previous release: ${{ env.RELEASE_TAG }}"
          gh release delete "${{ env.RELEASE_TAG }}" --yes 2>/dev/null || echo "No existing release found"
          git push --delete origin "${{ env.RELEASE_TAG }}" 2>/dev/null || echo "No existing tag found on remote"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate changelog
        id: changelog
        run: |
          # Extract version from tag
          VERSION="${RELEASE_TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Try to get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ] && [ "$LAST_TAG" != "$RELEASE_TAG" ]; then
            echo "üìù Changes since $LAST_TAG:"
            git log --oneline --no-merges "$LAST_TAG..HEAD" | head -20
          else
            echo "üìù Initial release or no previous tag found"
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.zip
            artifacts/**/latest*.yml
            artifacts/**/latest*.json
            artifacts/**/*.blockmap
          draft: true
          prerelease: ${{ contains(env.RELEASE_TAG, 'beta') || contains(env.RELEASE_TAG, 'alpha') || contains(env.RELEASE_TAG, 'rc') || contains(env.RELEASE_TAG, 'test') }}
          generate_release_notes: true
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: |
            ## üöÄ Automated Build
            
            **Build Information:**
            - **Version:** ${{ steps.changelog.outputs.version }}
            - **Trigger:** ${{ github.event_name }}
            - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            
            **üì¶ Included Platforms:**
            - ‚úÖ Windows (x64) - `.exe` installer & portable
            - ‚úÖ macOS (Intel & Apple Silicon) - `.dmg`
            - ‚úÖ Linux - `.AppImage` & `.deb`
            
            **üîß Build Environment:**
            - Node.js 20
            - GitHub Actions
            - Production mode
            
            ---
            
            *This release was automatically generated by GitHub Actions.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Success notification
        run: |
          echo "‚úÖ Release created successfully!"
          echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}"
          echo "üëÄ Preview: https://github.com/${{ github.repository }}/releases"